<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindSpore 多作物智慧诊断平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .crop-btn.active { background-color: #16a34a; color: white; border-color: #16a34a; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- 顶部导航 -->
    <header class="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="sprout" class="w-8 h-8"></i>
                <div>
                    <h1 class="text-xl font-bold">MindSpore 智慧植保</h1>
                    <p class="text-xs text-green-200">宇宙超级无敌祛病害大王</p>
                </div>
            </div>
            <div class="hidden md:block text-sm opacity-80">点击右下角按钮进行专家问答</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- 左侧：作物选择与上传 (占4列) -->
        <div class="lg:col-span-4 space-y-6">
            <!-- 1. 作物选择卡片 -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                    <i data-lucide="layout-grid" class="w-5 h-5 mr-2"></i> 第一步：选择作物
                </h3>
                <!-- 注意：这里的按钮仍然没有 ID，但我们会在 JS 中通过 data-crop 和 class 进行操作 -->
                <div class="flex flex-wrap gap-4">
                    <!-- 玉米 -->
                    <button type="button" data-crop="corn" class="crop-btn active px-4 py-2 rounded-lg border border-gray-300 flex items-center space-x-2 text-gray-700 hover:bg-green-50 hover:text-green-700">
                        <i data-lucide="wheat" class="w-5 h-5"></i>
                        <span>玉米</span>
                    </button>
                    <!-- 马铃薯 -->
                    <button type="button" data-crop="potato" class="crop-btn px-4 py-2 rounded-lg border border-gray-300 flex items-center space-x-2 text-gray-700 hover:bg-green-50 hover:text-green-700">
                        <i data-lucide="box" class="w-5 h-5"></i>
                        <span>马铃薯</span>
                    </button>
                    <!-- 番茄 -->
                    <button type="button" data-crop="tomato" class="crop-btn px-4 py-2 rounded-lg border border-gray-300 flex items-center space-x-2 text-gray-700 hover:bg-green-50 hover:text-green-700">
                        <i data-lucide="apple" class="w-5 h-5"></i>
                        <span>番茄</span>
                    </button>
                    <!-- 苹果 -->
                    <button type="button" data-crop="apple" class="crop-btn px-4 py-2 rounded-lg border border-gray-300 flex items-center space-x-2 text-gray-700 hover:bg-green-50 hover:text-green-700">
                        <i data-lucide="apple" class="w-5 h-5"></i>
                        <span>苹果</span>
                    </button>
                    <!-- 葡萄 -->
                    <button type="button" data-crop="grape" class="crop-btn px-4 py-2 rounded-lg border border-gray-300 flex items-center space-x-2 text-gray-700 hover:bg-green-50 hover:text-green-700">
                        <i data-lucide="grape" class="w-5 h-5"></i>
                        <span>葡萄</span>
                    </button>
                </div>
            </div>

            <!-- 2. 上传卡片 -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                    <i data-lucide="upload-cloud" class="w-5 h-5 mr-2"></i> 第二步：上传图片
                </h3>
                <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-green-500 hover:bg-green-50 transition">
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    <i data-lucide="image-plus" class="w-10 h-10 text-gray-400 mx-auto mb-2"></i>
                    <p class="text-gray-500 text-sm">点击或拖拽图片到这里</p>
                </div>
                <img id="preview-img" class="w-full h-48 object-contain mt-4 rounded-lg hidden bg-black">
                
                <button id="submit-btn" class="w-full mt-4 bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="scan-line" class="inline w-5 h-5 mr-1"></i> 开始智能诊断
                </button>
            </div>
        </div>

        <!-- 右侧：诊断报告 (占8列) -->
        <div class="lg:col-span-8">
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-gray-400 bg-white rounded-2xl shadow-sm border border-gray-100 p-10 min-h-[500px]">
                <i data-lucide="microscope" class="w-20 h-20 mb-4 opacity-20"></i>
                <p class="text-lg">请在左侧选择作物并上传图片</p>
                <p class="text-sm">诊断结果将显示在这里。右下角为 MaxKB 专家问答入口。</p>
            </div>

            <div id="result-screen" class="hidden space-y-6">
                <!-- 核心结果 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">检测结果 (MindSpore)</p>
                            <h2 id="res-name-cn" class="text-3xl font-bold text-gray-800">--</h2>
                            <p id="res-name-en" class="text-sm text-gray-400 font-mono mt-1">--</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500 mb-1">AI 置信度</p>
                            <div id="res-conf" class="text-2xl font-bold text-green-600">--%</div>
                        </div>
                    </div>
                </div>

                <!-- 光谱与健康度 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="activity" class="w-4 h-4 mr-2 text-blue-500"></i> 生理健康度指数 (VAI)
                        </h4>
                        <div class="flex items-center justify-center h-40">
                            <div class="text-center">
                                <div id="res-score" class="text-5xl font-bold text-blue-600">--</div>
                                <div class="text-xs text-gray-400 mt-2">分数越高，植株越健康</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="eye" class="w-4 h-4 mr-2 text-purple-500"></i> 光谱热力图
                        </h4>
                        <img id="res-heatmap" class="w-full h-40 object-contain rounded bg-gray-100">
                    </div>
                </div>

                <!-- 提示用户使用 MaxKB -->
                <div class="bg-yellow-50 p-4 rounded-xl shadow-sm border border-yellow-200 text-yellow-800 font-medium">
                    <p class="flex items-center"><i data-lucide="message-square" class="w-4 h-4 mr-2"></i> 如需防治建议，请点击右下角的 MaxKB 浮窗进行提问。</p>
                </div>
            </div>
        </div>
    </main>

    <!-- MaxKB 嵌入代码 (请修改 http://172.30.23.12:8080 为您的公网地址) -->

  
    <script
        async
        defer
        src="http://6525de12.r10.cpolar.top/api/application/embed?protocol=http&host=6525de12.r10.cpolar.top&token=3723fea6009cb392">
    </script>




    <script>
        lucide.createIcons();
        
        // ！！！请替换为 cpolar 的公网地址！！！
        const API_URL = "http://d19d3ff.r10.cpolar.top/predict";
        
        let currentCrop = 'corn'; // 默认作物
        
        // --- 修正后的作物选择逻辑 ---
        const cropBtns = document.querySelectorAll('.crop-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const resultScreen = document.getElementById('result-screen');

        cropBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const newCrop = btn.getAttribute('data-crop');
                
                // 1. 如果作物没有变化，则不做任何操作
                if (newCrop === currentCrop) return;
                
                // 2. 更新全局状态
                currentCrop = newCrop;
                
                // 3. 更新UI: 移除所有按钮的 active 状态
                cropBtns.forEach(b => b.classList.remove('active'));
                
                // 4. 更新UI: 添加 active 状态到当前点击的按钮
                btn.classList.add('active');
                
                // 5. 重置显示区，隐藏结果，显示欢迎屏（因为换了作物，结果需要重新诊断）
                resultScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');

                // 可选：清除已上传的图片和文件输入
                // fileInput.value = '';
                // previewImg.classList.add('hidden');
            });
        });
        // --- 修正后的作物选择逻辑结束 ---

        // 文件上传逻辑 (保持不变，但变量已在上方定义)
        const fileInput = document.getElementById('file-input');
        const dropArea = document.getElementById('drop-area');
        const previewImg = document.getElementById('preview-img');
        const submitBtn = document.getElementById('submit-btn');

        dropArea.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                // 使用 URL.createObjectURL 进行本地即时预览
                previewImg.src = URL.createObjectURL(file);
                previewImg.classList.remove('hidden');
                
                // 确保在上传图片后，如果还在欢迎页，则启用提交按钮
                submitBtn.disabled = false;
            }
        };

        // 提交按钮逻辑 (只处理 MindSpore 结果)
        submitBtn.onclick = async () => {
            // 确保 fileInput 变量在作用域内，它已被声明
            if (!fileInput.files[0]) return alert('请先上传图片');
            
            // 准备 UI
            welcomeScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin inline w-5 h-5 mr-1"></i> 正在智能诊断中...';
            lucide.createIcons(); // 重新加载图标，确保加载动画显示

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('crop_type', currentCrop);

            try {
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    // 1. 识别结果
                    document.getElementById('res-name-cn').innerText = data.disease_name_cn;
                    document.getElementById('res-name-en').innerText = data.disease_name_en;
                    document.getElementById('res-conf').innerText = data.confidence;
                    document.getElementById('res-score').innerText = data.health_score;
                    document.getElementById('res-heatmap').src = `data:image/png;base64,${data.heatmap_base64}`;
                    
                } else {
                    alert('诊断失败: ' + (data.error || '未知错误'));
                }
            } catch (err) {
                alert('网络错误，请检查 cpolar 地址');
                console.error(err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="scan-line" class="inline w-5 h-5 mr-1"></i> 开始智能诊断';
                lucide.createIcons(); // 恢复图标
            }
        };
    </script>
</body>
</html>